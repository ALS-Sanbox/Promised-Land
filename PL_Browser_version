<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Promised Land — Pharaoh Pursuit Campaign</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#121821;--ink:#e6edf3;--muted:#9db4c0;--accent:#93e2ff;
    --good:#86efac;--warn:#facc15;--bad:#f87171;--line:#1f2a37;
  }
  *{box-sizing:border-box}
  body{margin:0;background:radial-gradient(1200px 800px at 20% 0%, #142030 0%, #0b0f14 70%);color:var(--ink);
       font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{display:flex;gap:14px;align-items:center;flex-wrap:wrap;padding:16px 18px;border-bottom:1px solid var(--line);background:#0d141d}
  h1{font-size:18px;margin:0; flex-shrink:1}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid #27425a;background:#132233;color:var(--accent);
        font-size:11px;letter-spacing:.06em;font-weight:700;margin-left:8px}
  .controls{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
  button{padding:12px 16px;border-radius:10px;border:1px solid #203041;background:#152033;color:var(--ink);
         font-weight:700;cursor:pointer;font-size:14px;min-width:120px;transition:all 0.2s ease}
  button:hover{background:#1a2940;border-color:#2a435e;transform:translateY(-1px)}
  button.primary{background:#123552;border-color:#235c83}
  .audio-controls{display:flex;gap:8px;align-items:center}
  .volume-slider{width:80px;height:6px;border-radius:3px;background:#203041;outline:none;cursor:pointer}
  .volume-slider::-webkit-slider-thumb{width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}
  .audio-toggle{padding:8px;min-width:40px;background:#152033;border:1px solid #203041;font-size:16px}
  main{display:grid;grid-template-columns:1fr 2fr;gap:16px;padding:16px}
  @media(max-width:800px){
    main{grid-template-columns:1fr; padding:12px}
  }
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .section-title{margin:0 0 10px 0;color:var(--muted);font-size:13px;letter-spacing:.08em;text-transform:uppercase}
  .row{display:grid;grid-template-columns:1fr auto;gap:8px;padding:6px 0;border-bottom:1px dashed #223249}
  .row:last-child{border-bottom:0}
  .label{color:var(--muted)}
  .value{font-weight:800}
  progress{width:100%;height:10px}
  
  /* Enhanced event display with image support */
  #eventDisplay {
    min-height: 200px;
    margin-bottom: 12px;
  }
  
  .event-image {
    width: 100%;
    max-width: 400px;
    height: 200px;
    object-fit: cover;
    border-radius: 10px;
    border: 2px solid var(--line);
    margin-bottom: 12px;
    display: block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  
  .event-image.placeholder {
    background: linear-gradient(135deg, #1a2332, #2a3441);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--muted);
    font-size: 14px;
    text-align: center;
  }
  
  #eventText{
    white-space: pre-wrap;
    line-height: 1.5;
    min-height: 60px;
    overflow: auto;
  }
  
  .choices{display:grid;gap:8px;margin-top:12px}
  .choice{justify-content:flex-start;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .disabled{opacity:.5;cursor:not-allowed}
  .terminal{height:220px;overflow:auto;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
            font-size:13px;background:#0a0f15;border:1px solid var(--line);border-radius:10px;padding:10px}
  .muted{color:var(--muted)}
  .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .tag{display:inline-block;padding:2px 8px;border:1px solid #2a3c50;border-radius:999px;background:#0e1b29;color:var(--accent);font-size:11px}
  .divider{height:1px;background:linear-gradient(90deg, transparent, #243141, transparent);margin:8px 0}

  /* Audio indicator */
  .audio-indicator{
    position:fixed;
    top:20px;
    right:20px;
    background:rgba(18,24,33,0.9);
    border:1px solid var(--line);
    border-radius:8px;
    padding:8px 12px;
    font-size:12px;
    color:var(--muted);
    backdrop-filter:blur(10px);
    transition:opacity 0.3s ease;
    z-index:1000;
  }
  .audio-indicator.hidden{opacity:0;pointer-events:none}
</style>
</head>
<body>
	<header>
		<h1>Promised Land <span class="pill">Pharaoh Pursuit Campaign</span></h1>
		<div class="controls">
			<div class="audio-controls">
				<button class="audio-toggle" id="btnMute" title="Toggle Audio">🔊</button>
				<input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50" title="Master Volume">
			</div>
			<button class="primary" id="btnNew">New Campaign</button>
			<button id="btnClear">Clear Log</button>
		</div>
	</header>

  <main>
    <aside class="card">
      <h2 class="section-title">Status</h2>
      <div class="row"><div class="label">Day</div><div class="value" id="vDay">—</div></div>
      <div class="row"><div class="label">Location</div><div class="value" id="vLocation">—</div></div>
      <div class="row"><div class="label">Distance to Promise</div><div class="value"><span id="vDist">—</span> mi</div></div>
      <div class="row"><div class="label">Pharaoh's Army</div><div class="value" id="vPharaoh">—</div></div>
      <div class="divider"></div>
      <div class="row"><div class="label">People</div><div class="value" id="vPeople">—</div></div>
      <div class="row"><div class="label">Food</div><div class="value" id="vFood">—</div></div>
      <div class="row"><div class="label">Water</div><div class="value" id="vWater">—</div></div>
      <div class="row"><div class="label">Health</div><div class="value" id="vHealth">—</div></div>
      <div class="row"><div class="label">Morale</div><div class="value" id="vMorale">—</div></div>
      <div class="row"><div class="label">Faith</div><div class="value" id="vFaith">—</div></div>
      <div class="row"><div class="label">Supplies</div><div class="value" id="vSupplies">—</div></div>
      <div class="divider"></div>
      <div class="row"><div class="label">Progress</div><div class="value"><progress id="vProgress" value="0" max="100"></progress></div></div>
    </aside>

    <section class="card">
      <h2 class="section-title">Journey Log</h2>
      <div id="eventDisplay">
        <div id="eventText">Click <b>New Campaign</b> to begin your journey from Egypt.</div>
      </div>
      <div class="choices" id="choices"></div>
      <div class="divider"></div>
      <div class="terminal" id="log" aria-live="polite"></div>
    </section>
  </main>
  
<!-- Audio indicator -->
  <div class="audio-indicator hidden" id="audioIndicator">♪ Playing: Menu Theme</div>
<script>
/* ---------- Audio System ---------- */
class AudioManager {
  constructor() {
    this.sounds = {};
    this.music = {};
    this.currentMusic = null;
    this.masterVolume = 0.5;
    this.musicVolume = 0.3;
    this.sfxVolume = 0.7;
    this.muted = false;
    this.fadeInterval = null;
    
    this.initializeAudio();
    this.setupEventListeners();
  }

  initializeAudio() {
    // Define all audio files
    this.audioFiles = {
      // Background Music
      music: {
        //'menu': 'game_assets/sounds/menu_theme.mp3',
        //'egypt': 'game_assets/sounds/egypt_theme.mp3',
        //'desert': 'game_assets/sounds/desert_ambient.mp3',
        //'red_sea': 'game_assets/sounds/red_sea_theme.mp3',
        //'sinai': 'game_assets/sounds/sinai_theme.mp3',
        //'victory': 'game_assets/sounds/victory_theme.mp3',
        //'defeat': 'game_assets/sounds/defeat_theme.mp3',
        //'pharaoh_chase': 'game_assets/sounds/pharaoh_pursuit.mp3',
        //'peaceful': 'game_assets/sounds/peaceful_journey.mp3'
		'menu': 'game_assets/sounds/bg00.mp3',
        'egypt': 'game_assets/sounds/bg00.mp3',
        'desert': 'game_assets/sounds/bg00.mp3',
        'red_sea': 'game_assets/sounds/bg00.mp3',
        'sinai': 'game_assets/sounds/bg00.mp3',
        'victory': 'game_assets/sounds/bg00.mp3',
        'defeat': 'game_assets/sounds/bg00.mp3',
        'pharaoh_chase': 'game_assets/sounds/bg00.mp3',
        'peaceful': 'game_assets/sounds/bg00.mp3'
      },
      // Sound Effects
      sounds: {
        'button_click': 'game_assets/sounds/button_click.mp3',
        'button_hover': 'game_assets/sounds/button_hover.mp3',
        'choice_select': 'game_assets/sounds/choice_select.mp3',
        'travel': 'game_assets/sounds/travel_footsteps.mp3',
        'rest': 'game_assets/sounds/button_click.mp3',
        'event_positive': 'game_assets/sounds/button_click.mp3',
        'event_negative': 'game_assets/sounds/button_hover.mp3',
        'resource_gain': 'game_assets/sounds/choice_select.mp3',
        'resource_loss': 'game_assets/sounds/choice_select.mp3',
        'people_die': 'game_assets/sounds/choice_select.mp3',
        'miracle': 'game_assets/sounds/choice_select.mp3',
        'warning': 'game_assets/sounds/choice_select.mp3'
      }
    };

    // Preload all audio
    this.preloadAudio();
  }

  preloadAudio() {
    // Preload music
    Object.entries(this.audioFiles.music).forEach(([key, path]) => {
      const audio = new Audio();
      audio.src = path;
      audio.loop = true;
      audio.volume = 0;
      audio.preload = 'auto';
      
      // Handle loading errors gracefully
      audio.onerror = () => {
        console.warn(`Failed to load music: ${path}`);
      };
      
      this.music[key] = audio;
    });

    // Preload sound effects
    Object.entries(this.audioFiles.sounds).forEach(([key, path]) => {
      const audio = new Audio();
      audio.src = path;
      audio.volume = 0;
      audio.preload = 'auto';
      
      audio.onerror = () => {
        console.warn(`Failed to load sound: ${path}`);
      };
      
      this.sounds[key] = audio;
    });
  }

  setupEventListeners() {
    // Volume control
    const volumeSlider = document.getElementById('volumeSlider');
    volumeSlider.addEventListener('input', (e) => {
      this.setMasterVolume(e.target.value / 100);
    });

    // Mute button
    const muteBtn = document.getElementById('btnMute');
    muteBtn.addEventListener('click', () => {
      this.toggleMute();
    });

    // Add sound effects to all buttons
    this.addButtonSounds();
  }

  addButtonSounds() {
    // Add click sounds to all buttons
    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        if (e.target.classList.contains('choice')) {
          this.playSound('choice_select');
        } else {
          this.playSound('button_click');
        }
      }
    });

    // Add hover sounds to buttons
    document.addEventListener('mouseover', (e) => {
      if (e.target.tagName === 'BUTTON' && !e.target.disabled) {
        this.playSound('button_hover');
      }
    });
  }

  setMasterVolume(volume) {
    this.masterVolume = Math.max(0, Math.min(1, volume));
    this.updateAllVolumes();
    
    // Update UI
    document.getElementById('volumeSlider').value = this.masterVolume * 100;
  }

  updateAllVolumes() {
    const effectiveMusicVol = this.muted ? 0 : this.masterVolume * this.musicVolume;
    const effectiveSfxVol = this.muted ? 0 : this.masterVolume * this.sfxVolume;

    // Update music volumes
    Object.values(this.music).forEach(audio => {
      audio.volume = effectiveMusicVol;
    });

    // Update sound effect volumes
    Object.values(this.sounds).forEach(audio => {
      audio.volume = effectiveSfxVol;
    });
  }

  toggleMute() {
    this.muted = !this.muted;
    this.updateAllVolumes();
    
    // Update mute button
    const muteBtn = document.getElementById('btnMute');
    muteBtn.textContent = this.muted ? '🔇' : '🔊';
    muteBtn.title = this.muted ? 'Unmute Audio' : 'Mute Audio';
  }

  playSound(soundKey, volume = 1.0) {
    if (this.muted || !this.sounds[soundKey]) return;
    
    try {
      const sound = this.sounds[soundKey].cloneNode();
      sound.volume = this.masterVolume * this.sfxVolume * volume;
      sound.play().catch(e => console.warn('Sound play failed:', e));
    } catch (e) {
      console.warn('Sound play error:', e);
    }
  }

  playMusic(musicKey, fadeIn = true) {
    if (this.muted || !this.music[musicKey]) return;

    // Stop current music with fade out
    if (this.currentMusic && this.currentMusic !== this.music[musicKey]) {
      this.fadeOutMusic(this.currentMusic);
    }

    const newMusic = this.music[musicKey];
    this.currentMusic = newMusic;

    try {
      newMusic.currentTime = 0;
      
      if (fadeIn) {
        newMusic.volume = 0;
        newMusic.play().then(() => {
          this.fadeInMusic(newMusic);
        }).catch(e => console.warn('Music play failed:', e));
      } else {
        newMusic.volume = this.masterVolume * this.musicVolume;
        newMusic.play().catch(e => console.warn('Music play failed:', e));
      }

      // Update indicator
      this.updateAudioIndicator(musicKey);
    } catch (e) {
      console.warn('Music play error:', e);
    }
  }

  fadeInMusic(audio, duration = 2000) {
    if (this.fadeInterval) clearInterval(this.fadeInterval);
    
    const targetVolume = this.muted ? 0 : this.masterVolume * this.musicVolume;
    const steps = 50;
    const stepVolume = targetVolume / steps;
    const stepTime = duration / steps;
    let currentStep = 0;

    this.fadeInterval = setInterval(() => {
      if (currentStep >= steps || audio !== this.currentMusic) {
        clearInterval(this.fadeInterval);
        if (audio === this.currentMusic) {
          audio.volume = targetVolume;
        }
        return;
      }
      
      audio.volume = Math.min(stepVolume * currentStep, targetVolume);
      currentStep++;
    }, stepTime);
  }

  fadeOutMusic(audio, duration = 1500) {
    const startVolume = audio.volume;
    const steps = 30;
    const stepVolume = startVolume / steps;
    const stepTime = duration / steps;
    let currentStep = 0;

    const fadeInterval = setInterval(() => {
      if (currentStep >= steps) {
        clearInterval(fadeInterval);
        audio.pause();
        audio.volume = this.muted ? 0 : this.masterVolume * this.musicVolume;
        return;
      }
      
      audio.volume = Math.max(startVolume - (stepVolume * currentStep), 0);
      currentStep++;
    }, stepTime);
  }

  updateAudioIndicator(musicKey) {
    const indicator = document.getElementById('audioIndicator');
    const musicNames = {
      'menu': 'Menu Theme',
      'egypt': 'Egyptian March',
      'desert': 'Desert Winds',
      'red_sea': 'Waters Part',
      'sinai': 'Holy Mountain',
      'victory': 'Promised Land',
      'defeat': 'Lament',
      'pharaoh_chase': 'Royal Pursuit',
      'peaceful': 'Peaceful Journey'
    };

    indicator.textContent = `♪ Playing: ${musicNames[musicKey] || musicKey}`;
    indicator.classList.remove('hidden');
    
    // Auto-hide after 3 seconds
    setTimeout(() => {
      indicator.classList.add('hidden');
    }, 3000);
  }

  stopAllMusic() {
    Object.values(this.music).forEach(audio => {
      audio.pause();
      audio.currentTime = 0;
    });
    this.currentMusic = null;
  }

  // Context-specific music selection
  getMusicForContext(context, gameState) {
    if (!gameState) return 'menu';
    
    // Game over states
    if (gameState.over) {
      return gameState.victory ? 'victory' : 'defeat';
    }
    
    // Pharaoh pursuit tension
    if (!gameState.flags.redSea && gameState.pharaohDistance < 20) {
      return 'pharaoh_chase';
    }
    
    // Location-based music
    switch (gameState.location) {
      case 'Egypt':
        return 'egypt';
      case 'Red Sea':
        return 'red_sea';
      case 'Mount Sinai':
        return 'sinai';
      case 'Promised Land':
        return 'victory';
      default:
        // Desert locations with mood-based selection
        if (gameState.r.morale > 70 && gameState.r.faith > 60) {
          return 'peaceful';
        }
        return 'desert';
    }
  }
}

// Initialize audio manager
const audioManager = new AudioManager();

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
function write(line){
  const t=$('log');
  const atBottom=Math.abs(t.scrollHeight-t.scrollTop-t.clientHeight)<4;
  t.insertAdjacentHTML('beforeend', (''+line).replace(/&/g,'&amp;').replace(/</g,'&lt;')+'\n');
  if(atBottom) t.scrollTop=t.scrollHeight;
}
function clamp01to100(x){ return Math.max(0, Math.min(100, x)); }

/* ---------- Image Management ---------- */
const gameImages = {
  // Starting locations
  'egypt': 'game_assets/images/egypt.jpg',
  'departure': 'game_assets/images/departure.jpg',
  
  // Key locations
  'red_sea': 'game_assets/images/red_sea.jpg',
  'red_sea_crossing': 'game_assets/images/red_sea_crossing.jpg',
  'desert': 'game_assets/images/desert.jpg',
  'shur': 'game_assets/images/desert_shur.jpg',
  'sin': 'game_assets/images/desert_sin.jpg',
  'sinai': 'game_assets/images/mount_sinai.jpg',
  'promised_land': 'game_assets/images/promised_land.jpg',
  
  // Events
  'thirst': 'game_assets/images/thirst.jpg',
  'amalekites': 'game_assets/images/amalekites.jpg',
  'manna': 'game_assets/images/manna.jpg',
  'bitter_water': 'game_assets/images/bitter_water.jpg',
  'golden_calf': 'game_assets/images/golden_calf.jpg',
  'commandments': 'game_assets/images/ten_commandments.jpg',
  
  // Travel scenes
  'travel': 'game_assets/images/travel.jpg',
  'camp': 'game_assets/images/camp.jpg',
  'pharaoh_pursuit': 'game_assets/images/pharaoh_pursuit.jpg',
  
  // Victory/defeat
  'victory': 'game_assets/images/victory.jpg',
  'defeat': 'game_assets/images/defeat.jpg'
};

function showImageWithText(imageKey, text) {
  const eventDisplay = $('eventDisplay');
  const imagePath = gameImages[imageKey];
  
  let imageHTML = '';
  if (imagePath) {
    // Try to load the actual image
    imageHTML = `<img src="${imagePath}" alt="${imageKey}" class="event-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
    <div class="event-image placeholder" style="display:none;">📸 ${imageKey.replace('_', ' ').toUpperCase()}</div>`;
  } else {
    // Show placeholder
    imageHTML = `<div class="event-image placeholder">📸 ${imageKey.replace('_', ' ').toUpperCase()}</div>`;
  }
  
  eventDisplay.innerHTML = imageHTML + `<div id="eventText">${text}</div>`;
}

/* ---------- Game State ---------- */
let G=null;
let totalDistance=250;
function newCampaign(){
  G = {
    day:0,
    location:'Egypt',
    distance:totalDistance,
    pharaohDistance:100,
    people:600000,
    r:{ food:100, water:100, health:80, morale:70, faith:90, supplies:50 },
    flags:{ atRedSea:false, redSea:false, bitterwater: false, commandments:false, calf:false, manna:false, jordan:false },
    over:false, victory:false
  };
  $('log').textContent='';
  write('🎮 New campaign begun. You depart Egypt with 600,000 souls.');
  audioManager.playSound('event_positive');
  renderTravelRest("🌄 You are at the brink of Egypt. Pharaoh reconsiders and gives chase!", 'departure');
  updateHUD();
  updateMusic();
}

function updateMusic() {
  const musicKey = audioManager.getMusicForContext('game', G);
  audioManager.playMusic(musicKey);
}

/* ---------- HUD ---------- */
function updateHUD(){
  $('vDay').textContent       = G.day;
  $('vLocation').textContent  = G.location;
  $('vDist').textContent      = Math.max(0,G.distance);
  $('vPeople').textContent    = G.people.toLocaleString();
  $('vFood').textContent      = G.r.food+'%';
  $('vWater').textContent     = G.r.water+'%';
  $('vHealth').textContent    = G.r.health+'%';
  $('vMorale').textContent    = G.r.morale+'%';
  $('vFaith').textContent     = G.r.faith+'%';
  $('vSupplies').textContent  = G.r.supplies+'%';
  $('vProgress').value        = Math.round(((300 - G.distance)/300)*100);
  $('vPharaoh').textContent   = G.flags.redSea ? 'No longer pursuing' : (G.pharaohDistance+' mi behind');
}

/* ---------- Daily consumption & condition ---------- */
function endOfDay(factor=1){
  const cFood     = Math.floor((5+Math.random()*7) * factor);
  const cWater    = Math.floor((8+Math.random()*9) * factor);
  const cSupplies = Math.floor((1+Math.random()*3) * factor);
  G.r.food     = clamp01to100(G.r.food - cFood);
  G.r.water    = clamp01to100(G.r.water - cWater);
  G.r.supplies = clamp01to100(G.r.supplies - cSupplies);

  if(G.r.food < 20){ 
    G.r.health -= 5; 
    G.r.morale -= 3; 
    write('⚠️ Low food weakens the camp.'); 
    audioManager.playSound('warning');
  }
  if(G.r.water < 15){ 
    G.r.health -= 8; 
    G.r.morale -= 5; 
    write('⚠️ Severe thirst afflicts the people.'); 
    audioManager.playSound('warning');
  }
  G.r.health = clamp01to100(G.r.health);
  G.r.morale = clamp01to100(G.r.morale);

  if(G.r.health < 10){
    const deaths = Math.floor(500+Math.random()*1000);
    G.people = Math.max(0, G.people - deaths);
    write(`💀 ${deaths} people perished from poor conditions.`);
    audioManager.playSound('people_die');
  }
  G.day++;
}

/* ---------- Events (random pool) ---------- */
const randomEvents = [
  {
    name:"Thirst and Complaints",
    desc:"Water runs low. Murmurs spread in the camp.",
    image: 'thirst',
    choices:[
      {text:"Strike the rock (Faith ≥ 50)", req: s=>s.r.faith>=50, eff:{water:+30,faith:+10,morale:+15}},
      {text:"Search for a well", req: s=>true, eff:{water:+10,supplies:-5,health:-10}},
      {text:"Ration strictly", req: s=>true, eff:{water:+5,morale:-20,health:-10}}
    ]
  },
  {
    name:"Amalekite Skirmish",
    desc:"Raiders test your defenses at the camp's edge.",
    image: 'amalekites',
    choices:[
      {text:"Send Joshua with warriors", req:s=>true, eff:{morale:+10,faith:+5,food:-10,health:-10}},
      {text:"Raise the staff (Faith ≥ 60)", req:s=>s.r.faith>=60, eff:{faith:+20,morale:+15}},
      {text:"Retreat and lose supplies", req:s=>true, eff:{supplies:-30,morale:-15,health:-5}}
    ]
  },
  {
    name:"6th Day Manna from Heaven",
    desc:"Bread-like flakes cover the ground at dawn.",
    image: 'manna',
    choices:[
      {text:"Gather double portion", req:s=>true, eff:{food:+100,faith:+15,morale:+10,water:+100}, flag:'manna'},
      {text:"Store extra", req:s=>true, eff:{food:+5,faith:-10,health:-10,water:+5}},
      {text:"Question the miracle", req:s=>true, eff:{faith:-15,morale:-5}}
    ]
  }
];

function maybeRandomEvent(){
  if(Math.random() < 0.25){
    const e = randomEvents[Math.floor(Math.random()*randomEvents.length)];
    showEvent(e.name, e.desc, e.choices, e.image);
    return true;
  }
  return false;
}

/* ---------- Story Events ---------- */
function maybeStoryEvents(){
  if(!G.flags.redSea){
	toRed = totalDistance-G.distance;
	
    if(!G.flags.atRedSea && (toRed >= 90 )){
      G.flags.atRedSea = true;
      G.location = 'Red Sea';
      write('🌊 You arrive at the Red Sea. Pharaoh draws near!');
      redSeaEvent();
      return true;
    }else if(!G.flags.atRedSea && (G.pharaohDistance <= 13 )){
	  checkPharaohCatch();
	}
   } else if(!G.flags.bitterwater && G.day >= 10){
     G.location = 'Desert of Shur';
     bitterWaterEvent();
     return true;
  } else if(!G.flags.manna && G.day >= 25){
     G.location = 'Desert of Sin';
     mannaEvent();
     return true;
  } else if(!G.flags.commandments && G.day >= 16){
    G.location = 'Mount Sinai';
    commandmentsEvent();
    return true;
  } else if(G.flags.commandments && !G.flags.calf && G.day >= 32){
    goldenCalfEvent();
    return true;
  }
  return false;
}

function redSeaEvent(){
  const choices = [
    {text:"Raise staff over the waters (Faith ≥ 60)", req:s=>s.r.faith>=60, eff:{faith:+20,morale:+20}, onChoose:()=>{
      G.flags.redSea = true;
      G.flags.atRedSea = false;
      G.location = 'Desert Wilderness';
      G.pharaohDistance = null;
      write('✨ The waters part! Israel crosses on dry ground, and the army is swept away.');
      G.r.faith = clamp01to100(G.r.faith+20);
      G.r.morale = clamp01to100(G.r.morale+20);
      renderTravelRest('🏜️ You march into the wilderness, free of Pharaoh.', 'red_sea_crossing');
      updateHUD();
    }},
    {text:"March along the shore (consume time & supplies)", req:s=>true, eff:{food:-10,water:-10,supplies:-5,morale:-5}, onChoose:()=>{
      if(G.pharaohDistance!==null){ G.pharaohDistance = Math.max(0, G.pharaohDistance - 15); }
      write('😰 You search the shoreline for a crossing. Pharaoh gains significant ground.');
	  G.distance = Math.max(0, G.distance + 100);
      if(checkPharaohCatch()) return;
      redSeaEvent();
      updateHUD();
    }},
    {text:"Make camp and pray (no chance of escape)", req:s=>true, eff:{faith:+5,morale:+5,health:+5}, onChoose:()=>{
      if(G.pharaohDistance!==null){ G.pharaohDistance = Math.max(0, G.pharaohDistance - 12); }
      write('⏳ You wait and pray. The sea remains closed as Pharaoh approaches rapidly.');
	  G.distance = Math.max(0, G.distance + 100);
      if(checkPharaohCatch()) return;
      redSeaEvent();
      updateHUD();
    }}
  ];
  showEvent('Red Sea Crisis', 'The sea blocks your path; Pharaoh\'s army closes in.', choices, 'red_sea', true);
}

function bitterWaterEvent(){
  const choices = [
    {text:"Listen well to the voice of the Lord your God", req:s=>true, eff:{water:+200,faith:+30,morale:+20,health:+5}, onChoose:()=>{
      write('💦 Moses cried to the Lord, and the Lord showed him a tree. He threw it into the water, and the water became sweet.');
      renderTravelRest('⛺ The people encamp at and prepare to depart.', 'desert');
      updateHUD();
    }},
    {text:"Don\'t listen and boil the water to drink", req:s=>true, eff:{water:+10,faith:-30,morale:-20,health:-25}, onChoose:()=>{
	  G.people = Math.max(0, G.people - 1000);
	  G.distance = Math.max(0, G.distance + 100);
      write('🤢 God put the diseases on you which He had put on the Egyptians.');
      renderTravelRest('⛺ The people encamp at Shur and prepare to depart.', 'shur');
      updateHUD();
    }}
  ];
  G.flags.bitterwater = true;
  showEvent('Desert of Shur', 'You encamp at in the desert refilling your water supply.', choices, 'bitter_water', true);
}

function mannaEvent(){
  const choices = [
    {text:"Listen well to the voice of the Lord your God", req:s=>true, eff:{food:+200,faith:+30,morale:+20,health:+5}, onChoose:()=>{
      write('💦 Moses cried to the Lord, and the Lord Said, I will rain bread from heaven for you. The people will go out and gather a day\'s share every day.');
      renderTravelRest('⛺ The people encamp at Sin and prepare to depart.', 'sin');
      updateHUD();
    }},
    {text:"Don\'t listen and hunt for food", req:s=>true, eff:{food:+10,faith:-30,morale:-20,health:-25}, onChoose:()=>{
	  G.people = Math.max(0, G.people - 1000);
	  G.distance = Math.max(0, G.distance + 100);
      write('🤢 God put the diseases on you which He had put on the Egyptians.');
      renderTravelRest('⛺ The people encamp at and prepare to depart.', 'sin');
      updateHUD();
    }}
  ];
  G.flags.manna = true;
  showEvent('Desert of Sin', 'You encamp at in the desert gathering food supply.', choices, 'manna', true);
}

function commandmentsEvent(){
  const choices = [
    {text:"Ascend Sinai to receive the Law", req:s=>true, eff:{faith:+10}, onChoose:()=>{
      G.flags.commandments = true;
      write('📜 The Ten Commandments are given; the covenant is established.');
      renderTravelRest('⛺ The people encamp at Sinai and prepare to depart.', 'sinai');
      updateHUD();
    }}
  ];
  showEvent('Mount Sinai', 'You encamp at Sinai. A holy summons is given.', choices, 'commandments', true);
}

function goldenCalfEvent(){
  const choices = [
    {text:"Destroy the idol & punish rebels", req:s=>true, eff:{faith:+30,morale:-20}, onChoose:()=>{
      G.people = Math.max(0, G.people - 3000);
	  G.distance = Math.max(0, G.distance + 100);
      G.flags.calf = true;
      write('⚖️ Justice is carried out. The camp is sobered.');
      renderTravelRest('🕊️ The camp regathers after the incident.', 'desert');
      updateHUD();
    }},
    {text:"Reason with the people (Faith ≥ 40)", req:s=>s.r.faith>=40, eff:{faith:+10,morale:+5}, onChoose:()=>{
      G.flags.calf = true;
	  G.distance = Math.max(0, G.distance + 150);
      write('🤝 Many repent; order returns to the camp.');
      renderTravelRest('🕊️ The camp regathers after the incident.', 'desert');
      updateHUD();
    }},
    {text:"Ignore it (dangerous to faith)", req:s=>true, eff:{faith:-30,morale:+5}, onChoose:()=>{
      G.flags.calf = true;
	  G.distance = Math.max(0, G.distance + 200);
      write('😟 The people are confused; faith suffers.');
      renderTravelRest('🕊️ The camp regathers after the incident.', 'golden_calf');
      updateHUD();
    }}
  ];
  showEvent('Golden Calf Rebellion', 'While on the mountain, the people made an idol.', choices, 'golden_calf', true);
}

/* ---------- Event Renderer ---------- */
function showEvent(title, body, choices, imageKey = null, lockTurn=false){
  showImageWithText(imageKey || 'desert', `⚠️ ${title}\n${body}`);
  const box = $('choices'); box.innerHTML='';
  choices.forEach(ch=>{
    const btn=document.createElement('button');
    btn.className='choice';
    const allowed = ch.req ? ch.req(G) : true;
    btn.textContent = ch.text;
    if(!allowed){ btn.disabled=true; btn.classList.add('disabled'); }
    btn.addEventListener('click', ()=>{
      if(ch.eff) applyEffect(ch.eff);
      if(ch.onChoose) ch.onChoose();
      if(!lockTurn && !G.over){
        renderTravelRest();
        updateHUD();
      }
    });
    box.appendChild(btn);
  });
}

/* ---------- Travel / Rest UI ---------- */
function renderTravelRest(hint, imageKey = 'desert'){
  showImageWithText(imageKey, hint || 'Choose to travel onward or make camp to recover.');
  const box = $('choices'); box.innerHTML = '';
  const b1=document.createElement('button'); b1.textContent='Travel Onward';
  const b2=document.createElement('button'); b2.textContent='Make Camp / Rest';
  b1.addEventListener('click', travelTurn);
  b2.addEventListener('click', restTurn);
  box.appendChild(b1); box.appendChild(b2);
}

/* ---------- Turn Logic ---------- */
function travelTurn(){
  if(G.over) return;
  const march = 15;
  G.distance = Math.max(0, G.distance - march);
  if(!G.flags.redSea){
    G.pharaohDistance = Math.max(0, G.pharaohDistance - 12);
  }
  
  const imageKey = G.flags.redSea ? 'travel' : 'pharaoh_pursuit';
  showImageWithText(imageKey, `🚶 The people march onward.\nPharaoh and his army ${G.flags.redSea?'has been swept out to sea':(G.pharaohDistance+' miles behind')}.`);
  
  write('➡️ You press forward through the wilderness.');
  endOfDay(1.0);
  updateHUD();
  if(!maybeStoryEvents()){
    if(!G.flags.redSea){
      if(checkPharaohCatch()) return;
    }else{
      maybeRandomEvent();
    }
    updateHUD();
    checkWinLoss();
  }
}

function restTurn(){
  if(G.over) return;
  
  if(G.flags.manna){
    const choices = [
      {text:"Gather day's portion", req:s=>true, eff:{food:+15,water:+10,faith:+5,water:+15}, onChoose:()=>{
        write('🍞 You gather the daily manna as instructed.');
        completeRestTurn();
      }},
      {text:"Store extra (risky)", req:s=>true, eff:{food:+5,faith:-10,health:-10,water:+5}, onChoose:()=>{
	    G.distance = Math.max(0, G.distance + 100);
        write('🐛 The stored manna breeds worms and becomes foul.');
        completeRestTurn();
      }},
      {text:"Just rest without gathering", req:s=>true, eff:{faith:+2}, onChoose:()=>{
	    G.distance = Math.max(0, G.distance + 100);
        write('😴 You rest without gathering additional provisions.');
        completeRestTurn();
      }}
    ];
    showEvent('Camp & Manna', 'The camp rests. Manna covers the ground at dawn.', choices, 'camp', false);
  } else {
    completeRestTurn();
  }
}

function completeRestTurn(){
  G.r.health = clamp01to100(G.r.health + 10);
  G.r.morale = clamp01to100(G.r.morale + 6);
  G.r.faith  = clamp01to100(G.r.faith + 4);

  if(!G.flags.redSea){
    G.pharaohDistance = Math.max(0, G.pharaohDistance - 8);
  }
  
  showImageWithText('camp', `⛺ The camp rests and recovers.\nPharaoh is ${G.flags.redSea?'no longer pursuing':(G.pharaohDistance+' miles behind')}.`);
  
  write('🛖 You make camp. Pillar of fire glows against the desert night.');
  G.distance = Math.max(0, G.distance + 100);
  endOfDay(0.9);
  updateHUD();
  if(!maybeStoryEvents()){
    if(!G.flags.redSea){
      if(checkPharaohCatch()) return;
    }else{
      maybeRandomEvent();
    }
    updateHUD();
    checkWinLoss();
  }
}

/* ---------- Apply Effects ---------- */
function applyEffect(eff){
  for(const k in eff){
    const v = eff[k];
    if(['food','water','health','morale','faith','supplies'].includes(k)){
      G.r[k] = clamp01to100(G.r[k] + v);
      write(`📊 ${k[0].toUpperCase()+k.slice(1)} ${v>=0?'↑ +':'↓ '}${Math.abs(v)}`);
    }else if(k==='people'){
      G.people = Math.max(0, G.people + v);
      write((v>=0?'👥 +':'💀 -')+Math.abs(v)+' people');
    }
  }
}

/* ---------- Pharaoh Catch Check ---------- */
function checkPharaohCatch(){
  if(G.flags.redSea) return false;
  if(G.pharaohDistance <= 0){
    G.over = true; G.victory = false;
    showImageWithText('defeat', '💀 Pharaoh\'s army has overtaken the camp at the sea\'s edge.');
    $('choices').innerHTML = '';
    write('❌ Moses falls and Israel is enslaved again. The journey ends in tragedy.');
    return true;
  }
  return false;
}

/* ---------- Win / Loss ---------- */
function checkWinLoss(){
  if(G.people <= 0 || G.r.morale <= 0 || G.r.faith <= 0){
    G.over = true; G.victory = false;
    showImageWithText('defeat', '💀 GAME OVER — The people cannot continue.');
    $('choices').innerHTML = '';
    write('❌ The journey collapses in the wilderness.');
    return;
  }
  if(G.distance <= 0){
    G.over = true; G.victory = true;
    G.location = 'Promised Land';
    showImageWithText('victory', `🏆 VICTORY! You have reached the border of the Promised Land.
Final:
• People: ${G.people.toLocaleString()}
• Days: ${G.day}
• Faith: ${G.r.faith}% • Morale: ${G.r.morale}%`);
    $('choices').innerHTML = '';
    write('🎉 The promise stands before you. Well done.');
    updateHUD();
  }
}

/* ---------- Buttons ---------- */
$('btnNew').addEventListener('click', newCampaign);
$('btnClear').addEventListener('click', ()=>{ $('log').textContent=''; });

/* ---------- Boot Text ---------- */
// Initialize with starting image
showImageWithText('egypt', 'Click <b>New Campaign</b> to begin your journey from Egypt.');
write('Tip: Travel to stay ahead of Pharaoh. Rest to recover—but he will gain on you.');
write('Cross the Red Sea to end the pursuit. Keep faith and morale high!');
</script>
</body>
</html>
